name: Update Profile Index

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Update Organization Profile
        env:
          GH_TOKEN: ${{ secrets.GITFLOW_TOKEN }}
          ORG_NAME: "assforge"
          ORG_EMOJI: "ðŸ”¨"
          ORG_TITLE: "Tool Forge"
          ORG_SUBTITLE: "Development Tools & Frameworks"
          SECTION_TITLE: "Packages"
        run: |
          mkdir -p profile

          cat > profile/README.md << EOF
          # ${ORG_EMOJI} ${ORG_NAME}

          **${ORG_TITLE}** - ${ORG_SUBTITLE}

          ## ${SECTION_TITLE}

          | Repository | Description |
          |------------|-------------|
          EOF

          gh repo list "${ORG_NAME}" --no-archived --json name,description,url \
            --jq 'sort_by(.name) | .[] | select(.name != ".github") | "| [\(.name)](\(.url)) | \(.description // "â€”") |"' \
            >> profile/README.md

          cat >> profile/README.md << 'FOOTER'

          ---
          *Part of [Microsb Platform](https://microsb.net) Â· Auto-generated*
          FOOTER

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add profile/README.md
          git diff --staged --quiet || git commit -m "chore: update repo index"
          git push

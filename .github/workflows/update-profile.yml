name: Update Profile Index

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate repo index
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > profile/README.md << 'HEADER'
          # ðŸ”¨ assforge

          **Tool Forge** - Microsb Development Tools

          ## Packages

          | Repository | Description |
          |------------|-------------|
          HEADER

          gh repo list ${{ github.repository_owner }} --no-archived --json name,description,url \
            --jq 'sort_by(.name) | .[] | select(.name != ".github") | "| [\(.name)](\(.url)) | \(.description // "â€”") |"' \
            >> profile/README.md

          cat >> profile/README.md << 'FOOTER'

          ---
          *Part of [Microsb Platform](https://microsb.net) Â· Auto-generated*
          FOOTER

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add profile/README.md
          git diff --staged --quiet || git commit -m "chore: update repo index"
          git push
